# Alibaba Sigma
> Sigma 是阿⾥巴巴全集团范围的 Pouch 容器调度系统。2017年是 Sigma 正式上线以来第⼀次参与双11，在双11期间成功⽀撑了全集团所有容器（交易线中间件、数据库、⼴告等⼆⼗多业务）的调配，使双11IT成本降低50%，是阿⾥巴巴运维系统重要的底层基础设施。
> 

## 1. 什么是Sigma？
Sigma集群管理系统是阿里巴巴集团云化战略的关键系统。Sigma通过和离线任务的伏羲调度系统深度集成，突破了若干CPU、内存和网络资源隔离的关键技术，实现了在线和离线任务的混合部署。

## 2. Sigma的出现原因：
阿里巴巴最初做调度的时候，各个部门技术架构相对比较独立，有各自的资源池，也能够比较垂直的从上至下做一整套技术栈。不过，这样也有一个比较大的缺点：在大规模资源使用的情况下如双11，一些没有直接参与双11交易链路的资源可能比较空闲，而双11直接相关的系统又背负着较大的资源压力，资源的使用率不均衡导致资源严重浪费。所以需要一个调度系统去整合各部分资源，逻辑上要统一资源池，更充分的分配和使用各部分资源。把计算任务与在线服务进行混合部署，在现有弹性资源基础上提升集群资源利用率，降低双11资源新增成本。Sigma调度系统由此而生。

## 3. Characteristics

### 3.1 Sigma调度系统的整理架构：

下图为Sigma调度系统的整理架构，有Alikenel、SigmaSlave、SigmaMaster三层大脑联动合作。

![image](https://raw.githubusercontent.com/199ChenNuo/grade3-semester1-homework/master/sigma/1.png)

- Alikenel部署在每一台NC上，对内核进行增强，在资源分配、时间片分配上进行灵活的按优先级和策略调整，对任务的时延，任务时间片的抢占、不合理抢占的驱逐都能通过上层的规则配置自行决策。
- SigmaSlave可以在本机上进行CPU的分配、应急场景的处理。通过本机Slave对时延敏感任务快速做出决策和响应，避免因全局决策处理时间长带来的业务损失。
- SigmaMaster是一个最强的大脑，它可以统揽全局，为大量物理机的容器部署进行资源调度分配和算法优化决策。

### 3.2 混合部署：
 

阿里通过调度集群管理系统，实现资源的效率的提升，这里有一个非常关键的技术叫做混部。将一种对于资源的使用可以随时去避让的业务如计算任务，和一种对资源使用要求很高的延时敏感的任务如在线服务部署在一起。当发生紧急情况时，将资源分配给对延时敏感的紧急任务，实现资源的有效分配。

> “在线服务的容器就像砖块，而计算任务就像沙子和水。当在线服务压力小的时候，计算任务就占住那些空隙，把空闲的资源都使用起来，而当在线服务忙的时候，计算任务便立即退出空隙，把资源还给在线服务。”

下图为阿里基于Sigma与Fuxi混布架构：

![image](https://raw.githubusercontent.com/199ChenNuo/grade3-semester1-homework/master/sigma/2.png)

在线服务属于长生命周期、规则策略复杂性高、时延敏感类任务。而计算任务生命周期短、调度要求大并发高吞吐、任务有不同的优先级、对时延不敏感。基于这两种调度的本质诉求的不同，我们在混合部署的架构上把两种调度并行处理，即一台物理机上可以既有 Sigma 调度又有 Fuxi 调度，实现基础环境统一。Sigma 调度是通过 SigmaAgent 启动 PouchContainer 容器。Fuxi 也在这台物理机上抢占资源，启动自己的计算任务。所有在线任务都在 PouchContainer 容器上，它负责把服务器资源进行分配并运行在线任务，离线任务填入其空白区，保证物理机资源利用达到饱和，这样就完成了两种任务的混合部署。

### 4. Pros：
- 通过混部，系统在平时可以极大地提升服务器资源利用率：而在双 11 这样的大促活动需要突增在线服务能力的时候，又可以通过在线服务占用计算任务资源的方式，来顶住短暂的超高峰值压力。混布之后在线机器的平均资源利用率从之前的10%左右提高到了现在的40%以上，并且同时保证了在线服务的SLO目标。
 
![image](https://raw.githubusercontent.com/199ChenNuo/grade3-semester1-homework/master/sigma/3.png)

- 复杂约束下的批量调度优化：调度主要在竞争之前，通过资源画像，尽量减少资源竞争的可能性；提高了在线任务调度优先级。对应用的内存、CPU、网络、磁盘和网络 I/O 容量进行画像，知道它的特征、资源规格需求，不同的时间对资源真实使用情况，然后对整体规格和时间进行相关性分析，进行整体调度优化。

- 内核在发生资源竞争的极端情况时，优先保障高优先级任务。
解决了在 / 离线超线程资源争抢问题。 
在内存隔离上，拥有 CGroup 隔离 /OOM 优先级；Bandwidth Control 减少离线配额实现带宽隔离。
在内存弹性上，在内存不增加的情况下，提高混部效果，在线闲置时离线突破 memcg limit；需要内存时，离线及时释放。

- 精确高水位排布
不同的场景有不同的策略，双 11 的策略是稳定优先，稳定性优先代表采用平铺策略，把所有的资源用尽，让资源层全部达到最低水位。日常场景需要利用率优先，“利用率优先” 指让已经用掉的资源达到最高水位，空出大量完整资源做规模化的计算。![image](https://raw.githubusercontent.com/199ChenNuo/grade3-semester1-homework/master/sigma/4.png)

- 大规模快速建站：日常扩容仅预热基础镜像；
大促建站预热基础镜像；
大促建站针对性预热最热门的应用镜像；
大促建站针对独占资源池:指定具体的应用,提前镜像预热。

### 5. Cons
-  在大规模快速建站方面，阿里一方面将一些热门应用的镜像提前预热，但是某些时候宿主机的磁盘容量较小，而阿里的富容器镜像又比较大，当一次一键建站应用种类过多时，如果全部镜像种类都预热到对应机器上，那么磁盘是不够用的。
-  生产环境场景比较丰富，可能出现一些在测试环境下未曾预测到的场景，出现一些预期外的问题。
- 闭源
- 资源利用率比不上borg

### 6. My comment

近10年移动互联网、互联网+的浪潮，使互联网技术渗透到各行各业，渗透到人们生活的方方面面，这带来了互联网服务规模和数据规模的大幅增长，日益增长的服务规模和数据规模带来数据中心的急剧膨胀。Sigma 调度把服务器资源进行分配并运行在线任务，离线任务填入其空白区，保证物理机资源利用达到饱和，大幅度提高了CPU 的平均利用率，降低整个行业的IT成本，可以带来非常可观的成本节约，加速整个行业的创新发展。 


### 7. Reference


《史无前例开放！阿里内部集群管理系统Sigma混布数据》https://mp.weixin.qq.com/s/4-7LLacEksMGfw6eZPz53w?spm=a2c4e.11153940.blogcont196244.12.beec394fkfGVqV

《阿里巴巴 Sigma 调度和集群管理系统架构详解》http://blog.51cto.com/13778063/2155360?source=dra

《想了解阿里巴巴的云化架构 看这篇就够了》http://www.infoq.com/cn/news/2017/12/Cloud-Sigma-Pouch-Alibaba

《如何提升集群资源利用率？ 阿里容器调度系统Sigma 深入解析》https://www.cnblogs.com/qwangxiao/p/8719513.html

《阿里决战双11核心技术揭秘——混部调度助力云化战略再次突破》https://www.leiphone.com/news/201711/HHa8Y9tPeVgB1Kt8.html

《Sigma调度与集群管理系统介绍》
http://www.doc88.com/p-7009180649046.html


